<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Elbow Angle Analysis</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f2f2f2;
      text-align: center;
      color: #333;
    }
    header {
      background-color: #003366;
      color: #fff;
      padding: 20px;
      font-size: 36px;
      font-weight: bold;
    }
    #controls {
      margin: 20px;
      display: flex;
      justify-content: center;
    }
    .upload-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .upload-container label {
      cursor: pointer;
      padding: 10px 20px;
      background-color: #003366;
      color: #fff;
      border-radius: 5px;
      font-size: 16px;
      margin-bottom: 5px;
    }
    .upload-container input {
      display: none;
    }
    #canvasContainer {
      display: flex;
      justify-content: center;
      margin: 0 auto;
      max-width: 90%;
    }
    canvas {
      background-color: #fff;
      border: 1px solid #ccc;
      max-width: 100%;
      height: auto;
    }
    #report {
      margin: 20px auto;
      padding: 15px;
      background: #fff;
      border: 1px solid #ccc;
      max-width: 600px;
      text-align: left;
      font-size: 18px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <header>Elbow Angle Analysis</header>
  <div id="controls">
    <div class="upload-container">
      <label for="imageInput">Upload Image</label>
      <input type="file" id="imageInput" accept="image/*">
    </div>
  </div>
  <div id="canvasContainer">
    <canvas id="canvas"></canvas>
  </div>
  <div id="report"></div>

  <!-- Load MediaPipe Pose and Drawing Utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script>
    // Maximum display width
    const maxWidth = 600;
    
    // We'll use two sets of landmarks:
    // Left elbow: indices 11, 13, 15
    // Right elbow: indices 12, 14, 16
    const LEFT_SHOULDER_IDX = 11;
    const LEFT_ELBOW_IDX = 13;
    const LEFT_WRIST_IDX = 15;
    
    const RIGHT_SHOULDER_IDX = 12;
    const RIGHT_ELBOW_IDX = 14;
    const RIGHT_WRIST_IDX = 16;
    
    // Variables for image dimensions and computed angles
    let imgWidth = 0, imgHeight = 0;
    let leftElbowAngle = null, rightElbowAngle = null;
    
    // Get canvas and report elements
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const reportDiv = document.getElementById('report');
    
    // Helper: Calculate angle between three points (in degrees)
    function calculateAngle(a, b, c) {
      const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
      let angle = Math.abs(radians * 180.0 / Math.PI);
      if (angle > 180) angle = 360 - angle;
      return angle;
    }
    
    // Helper: Convert normalized landmark to pixel coordinates
    function toPixel(landmark, width, height) {
      return { x: landmark.x * width, y: landmark.y * height };
    }
    
    // Initialize MediaPipe Pose
    const pose = new Pose({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });
    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });
    pose.onResults(onResults);
    
    // Process uploaded image
    document.getElementById('imageInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        // Scale image if necessary
        if (img.width > maxWidth) {
          const scale = maxWidth / img.width;
          imgWidth = img.width * scale;
          imgHeight = img.height * scale;
        } else {
          imgWidth = img.width;
          imgHeight = img.height;
        }
        canvas.width = imgWidth;
        canvas.height = imgHeight;
        // Draw original image
        ctx.drawImage(img, 0, 0, imgWidth, imgHeight);
        // Process the image with MediaPipe Pose
        pose.send({ image: img });
      };
      img.src = URL.createObjectURL(file);
    });
    
    // onResults callback from MediaPipe Pose
    function onResults(results) {
      // Clear the canvas and redraw the image
      ctx.clearRect(0, 0, imgWidth, imgHeight);
      ctx.drawImage(results.image, 0, 0, imgWidth, imgHeight);
      if (!results.poseLandmarks) {
        reportDiv.innerHTML = "<p>No pose detected.</p>";
        return;
      }
      
      const landmarks = results.poseLandmarks;
      
      // For the left elbow measurement (using landmarks 11, 13, 15)
      const leftShoulder = toPixel(landmarks[LEFT_SHOULDER_IDX], imgWidth, imgHeight);
      const leftElbow = toPixel(landmarks[LEFT_ELBOW_IDX], imgWidth, imgHeight);
      const leftWrist = toPixel(landmarks[LEFT_WRIST_IDX], imgWidth, imgHeight);
      leftElbowAngle = calculateAngle(leftShoulder, leftElbow, leftWrist);
      
      // For the right elbow measurement (using landmarks 12, 14, 16)
      const rightShoulder = toPixel(landmarks[RIGHT_SHOULDER_IDX], imgWidth, imgHeight);
      const rightElbow = toPixel(landmarks[RIGHT_ELBOW_IDX], imgWidth, imgHeight);
      const rightWrist = toPixel(landmarks[RIGHT_WRIST_IDX], imgWidth, imgHeight);
      rightElbowAngle = calculateAngle(rightShoulder, rightElbow, rightWrist);
      
      // Draw connectors and landmarks manually for left elbow (blue lines)
      ctx.beginPath();
      ctx.moveTo(leftShoulder.x, leftShoulder.y);
      ctx.lineTo(leftElbow.x, leftElbow.y);
      ctx.lineTo(leftWrist.x, leftWrist.y);
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 6;
      ctx.stroke();
      // Draw red circles for left landmarks
      [leftShoulder, leftElbow, leftWrist].forEach(pt => {
        ctx.beginPath();
        ctx.arc(pt.x, pt.y, 6, 0, 2 * Math.PI);
        ctx.fillStyle = '#FF0000';
        ctx.fill();
      });
      ctx.font = "20px Arial";
      ctx.fillStyle = "white";
      ctx.fillText(`Angle: ${leftElbowAngle.toFixed(0)}째`, leftElbow.x, leftElbow.y - 10);
      
      // Draw connectors and landmarks manually for right elbow (yellow lines)
      ctx.beginPath();
      ctx.moveTo(rightShoulder.x, rightShoulder.y);
      ctx.lineTo(rightElbow.x, rightElbow.y);
      ctx.lineTo(rightWrist.x, rightWrist.y);
      ctx.strokeStyle = '#ffff00';
      ctx.lineWidth = 6;
      ctx.stroke();
      // Draw blue circles for right landmarks
      [rightShoulder, rightElbow, rightWrist].forEach(pt => {
        ctx.beginPath();
        ctx.arc(pt.x, pt.y, 6, 0, 2 * Math.PI);
        ctx.fillStyle = '#0000FF';
        ctx.fill();
      });
      ctx.font = "20px Arial";
      ctx.fillStyle = "black";
      ctx.fillText(`Angle: ${rightElbowAngle.toFixed(0)}째`, rightElbow.x, rightElbow.y - 10);
      
      // Update the report below the image
      updateReport();
    }
    
    function updateReport() {
      let reportHTML = "";
      if (leftElbowAngle !== null) {
        reportHTML += `<h3>Left Elbow Angle</h3>
          <p>Angle: ${leftElbowAngle.toFixed(2)}째</p>`;
      }
      if (rightElbowAngle !== null) {
        reportHTML += `<h3>Right Elbow Angle</h3>
          <p>Angle: ${rightElbowAngle.toFixed(2)}째</p>`;
      }
      reportDiv.innerHTML = reportHTML;
    }
  </script>
</body>
</html>
